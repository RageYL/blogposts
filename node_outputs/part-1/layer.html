
	<!DOCTYPE html>
	<html>
	<head>
		<meta charset="UTF-8">

		<!--
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css" />
		-->

		<link rel="stylesheet" href="/node_sources/part-x/index-v1.css">
		<link rel="stylesheet" href="/node_modules/katex/dist/katex.min.css">
		<link rel="stylesheet" href="/node_modules/highlight.js/styles/default.css">

		<link rel="stylesheet" href="/node_modules/slick-carousel/slick/slick.css">
		<link rel="stylesheet" href="/node_modules/slick-carousel/slick/slick-theme.css">

		<script src="/node_modules/lodash/lodash.min.js"></script>
		<script src="/node_modules/highcharts/highcharts.js"></script>
		<script src="/node_modules/jquery/dist/jquery.min.js"></script>
		<script src="/node_modules/slick-carousel/slick/slick.min.js"></script>

		<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
	</head>
	<body>
		<div id="content">
			<h1>More about neural networks</h1>
<p>Before we look at a more serious issues, we need to learn a bit more about
neural networks and keras.</p>
<p>Let's take a fresh look at the first neural network picture:</p>
<p><img src="/node_outputs/part-1/images-js/neural-net-2332.png" alt=""></p>
<p>We can see that neurons form groups called layers.</p>
<p><img src="/node_outputs/part-1/images-js/neural-net-2332-layers.png" alt=""></p>
<p>Layers have special names:</p>
<ul>
<li>The first one is called input layer</li>
<li>The last one is called output layer</li>
<li>All the others, in between, are called hidden layers</li>
</ul>
<p><img src="/node_outputs/part-1/images-js/neural-net-2332-layers-names.png" alt=""></p>
<p>The weights belongs to the layers, not the inputs: (rephrase)</p>
<p><img src="/node_outputs/part-1/images-js/neural-net-2332-weights-names.png" alt=""></p>
<p>We are now ready to talk about <code>Dense</code> and <code>Sequential</code> !</p>
<h2>Dense</h2>
<p>If we look at the imports, we can see that <code>Dense</code> is a layer.</p>
<pre><code class="language-python"><span class="hljs-keyword">from</span> keras.layers <span class="hljs-keyword">import</span> Dense
</code></pre>
<p>A <code>Dense</code> layer simply create a bunch of neurons and connect each one of them to
every single input.</p>
<pre><code class="language-python">Dense(<span class="hljs-number">3</span>, use_bias = <span class="hljs-keyword">False</span>, input_shape = (<span class="hljs-number">2</span>,))
</code></pre>
<p><img src="/node_outputs/part-1/images-js/neural-net-23.png" alt=""></p>
<pre><code class="language-python">Dense(<span class="hljs-number">3</span>, use_bias = <span class="hljs-keyword">True</span>, input_shape = (<span class="hljs-number">2</span>,))
</code></pre>
<p><img src="/node_outputs/part-1/images-js/neural-net-23-bias.png" alt=""></p>
<p><code>Dense</code> layers are often referred as Fully Connected (FC) layers in the
litterature.</p>
<div class="note">
<p>There is more than one kind of layer, we will introduce them as we go.</p>
</div>
<h2>Sequential</h2>
<p>Until now, we only created networks with one layer. What if wanted we create a
deeper network ? Well, this is where <code>Sequential</code> kicks in.</p>
<pre><code class="language-python"><span class="hljs-keyword">from</span> keras.models <span class="hljs-keyword">import</span> Sequential
</code></pre>
<p><code>Sequential</code> is a model that stacks layers: every time you <code>add()</code> a layer, it is
inserted at the end of the model.</p>
<pre><code class="language-python">model = Sequential()
model.add(Dense(<span class="hljs-number">3</span>, use_bias = <span class="hljs-keyword">False</span>, input_shape = (<span class="hljs-number">2</span>,)))
</code></pre>
<p><img src="/node_outputs/part-1/images-js/neural-net-23.png" alt=""></p>
<pre><code class="language-python">model.add(Dense(<span class="hljs-number">3</span>, use_bias = <span class="hljs-keyword">False</span>))
</code></pre>
<p><img src="/node_outputs/part-1/images-js/neural-net-233.png" alt=""></p>
<pre><code class="language-python">model.add(Dense(<span class="hljs-number">2</span>, use_bias = <span class="hljs-keyword">False</span>))
</code></pre>
<p><img src="/node_outputs/part-1/images-js/neural-net-2332.png" alt=""></p>
<p>You may have noticed that only the first layer require <code>input_shape</code>. All
subsequent layers will use the neurons of the previous layer as inputs.</p>
<h2>Playing with keras</h2>
<p>Keras offers some nice methods and attributes to play with layers. I will
briefly introduce those we will use in this post. Refer to the official
documentation for more information.</p>
<ul>
<li><code>Model.summary()</code>: displays a textual represention of the model</li>
</ul>
<pre><code class="language-python">model.summary()

<span class="hljs-comment">#&gt; _________________________________________________________________</span>
<span class="hljs-comment">#&gt; Layer (type)                 Output Shape              Param #</span>
<span class="hljs-comment">#&gt; =================================================================</span>
<span class="hljs-comment">#&gt; dense_1 (Dense)              (None, 3)                 6</span>
<span class="hljs-comment">#&gt; _________________________________________________________________</span>
<span class="hljs-comment">#&gt; dense_2 (Dense)              (None, 3)                 9</span>
<span class="hljs-comment">#&gt; _________________________________________________________________</span>
<span class="hljs-comment">#&gt; dense_3 (Dense)              (None, 2)                 6</span>
<span class="hljs-comment">#&gt; =================================================================</span>
<span class="hljs-comment">#&gt; Total params: 21</span>
<span class="hljs-comment">#&gt; Trainable params: 21</span>
<span class="hljs-comment">#&gt; Non-trainable params: 0</span>
<span class="hljs-comment">#&gt; _________________________________________________________________</span>
</code></pre>
<ul>
<li><code>Model.layers</code>: attribute containing all the layers added to the model</li>
</ul>
<pre><code class="language-python">model.layers

<span class="hljs-comment">#&gt; [&lt;keras.layers.core.Dense at 0x7f3797d52cc0&gt;,</span>
<span class="hljs-comment">#&gt;  &lt;keras.layers.core.Dense at 0x7f3797d31940&gt;,</span>
<span class="hljs-comment">#&gt;  &lt;keras.layers.core.Dense at 0x7f3797cd4c18&gt;]</span>
</code></pre>
<ul>
<li><code>Model.get_weights()</code>: get the weights of each layer</li>
<li><code>Model.set_weights()</code>: set the weights of each layer</li>
</ul>
<pre><code class="language-python">model.get_weights()

<span class="hljs-comment">#&gt; [array([[-0.71340144, -0.03733754,  0.17574036],</span>
<span class="hljs-comment">#&gt;         [-0.93694097, -0.81433576, -0.4139728 ]], dtype=float32),</span>
<span class="hljs-comment">#&gt;  array([[-0.64885306, -0.59295535,  0.0623827 ],</span>
<span class="hljs-comment">#&gt;         [-0.86857986, -0.84055448,  0.59113455],</span>
<span class="hljs-comment">#&gt;         [-0.59811687,  0.80146456, -0.72720838]], dtype=float32),</span>
<span class="hljs-comment">#&gt;  array([[-1.04037547, -0.68300182],</span>
<span class="hljs-comment">#&gt;         [ 0.88082504,  0.62239075],</span>
<span class="hljs-comment">#&gt;         [ 0.56199396,  0.19530547]], dtype=float32)]</span>

model.set_weights([
    [[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>)], <span class="hljs-comment"># 3 neurons, 2 inputs</span>
    [[<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>)], <span class="hljs-comment"># 3 neurons, 3 inputs</span>
    [[<span class="hljs-number">7</span>, <span class="hljs-number">8</span>   ] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">3</span>)], <span class="hljs-comment"># 2 neurons, 3 inputs</span>
])

model.get_weights()

<span class="hljs-comment">#&gt; [array([[ 1.,  2.,  3.],</span>
<span class="hljs-comment">#&gt;         [ 1.,  2.,  3.]], dtype=float32),</span>
<span class="hljs-comment">#&gt;  array([[ 4.,  5.,  6.],</span>
<span class="hljs-comment">#&gt;         [ 4.,  5.,  6.],</span>
<span class="hljs-comment">#&gt;         [ 4.,  5.,  6.]], dtype=float32),</span>
<span class="hljs-comment">#&gt;  array([[ 7.,  8.     ],</span>
<span class="hljs-comment">#&gt;         [ 7.,  8.     ],</span>
<span class="hljs-comment">#&gt;         [ 7.,  8.     ]], dtype=float32)]</span>
</code></pre>
<ul>
<li><code>Layer.get_weights()</code>: get the weights of a layer</li>
<li><code>Layer.set_weights()</code>: set the weights of a layer</li>
</ul>
<pre><code class="language-python">model.layers[<span class="hljs-number">0</span>].get_weights()

<span class="hljs-comment">#&gt; [array([[ 1.,  2.,  3.],</span>
<span class="hljs-comment">#&gt;         [ 1.,  2.,  3.]], dtype=float32)]</span>

model.layers[<span class="hljs-number">1</span>].get_weights()

<span class="hljs-comment">#&gt; [array([[ 4.,  5.,  6.],</span>
<span class="hljs-comment">#&gt;         [ 4.,  5.,  6.],</span>
<span class="hljs-comment">#&gt;         [ 4.,  5.,  6.]], dtype=float32)]</span>

model.layers[<span class="hljs-number">2</span>].get_weights()
model.layers[<span class="hljs-number">2</span>].set_weights([np.array([
    [<span class="hljs-number">7</span>, <span class="hljs-number">8</span>],
    [<span class="hljs-number">7</span>, <span class="hljs-number">8</span>],
    [<span class="hljs-number">7</span>, <span class="hljs-number">8</span>],
])])

<span class="hljs-comment">#&gt; [array([[ 7.,  8.],</span>
<span class="hljs-comment">#&gt;         [ 7.,  8.],</span>
<span class="hljs-comment">#&gt;         [ 7.,  8.]], dtype=float32)]</span>
</code></pre>
<h3>Math</h3>
<p>How do we compute something when we have multiple neurons ? We evaluate each one
independently. They all have their own weights and share the same inputs.</p>
<style>
.carousel > p
{
    display: none;
}
</style>
<div id="layer-computation" class="carousel">
<p><img src="/node_outputs/part-1/images-js/nnet-23-inputs.png" alt="">
<img src="/node_outputs/part-1/images-js/nnet-23-neuron-1.png" alt="">
<img src="/node_outputs/part-1/images-js/nnet-23-neuron-2.png" alt="">
<img src="/node_outputs/part-1/images-js/nnet-23-neuron-3.png" alt="">
<img src="/node_outputs/part-1/images-js/nnet-23-outputs.png" alt=""></p>
</div>
<script> createCarousel($("#layer-computation p")) </script>
<p>And when we have multiple layers ? Well we begin by computing the first layer
using the input data. Then we compute the next layer using the
previous layer as input, until the end.</p>
<div id="network-computation" class="carousel">
<p><img src="/node_outputs/part-1/images-js/nnet-2332-inputs.png" alt="">
<img src="/node_outputs/part-1/images-js/nnet-2332-layer-x-0.png" alt="">
<img src="/node_outputs/part-1/images-js/nnet-2332-layer-z-1.png" alt="">
<img src="/node_outputs/part-1/images-js/nnet-2332-layer-x-1.png" alt="">
<img src="/node_outputs/part-1/images-js/nnet-2332-layer-z-2.png" alt="">
<img src="/node_outputs/part-1/images-js/nnet-2332-layer-x-2.png" alt="">
<img src="/node_outputs/part-1/images-js/nnet-2332-layer-z-3.png" alt="">
<img src="/node_outputs/part-1/images-js/nnet-2332-layer-x-3.png" alt="">
<img src="/node_outputs/part-1/images-js/nnet-2332-outputs.png" alt=""></p>
</div>
<script> createCarousel($("#network-computation p")) </script>
<p>As we can see we start with inputs on the left and we go all the way to the
right. This is called the forward pass:</p>
<p><img src="/node_outputs/part-1/images-js/nnet-2332-forward.png" alt=""></p>
<h1>Code</h1>
<p>a <code>Dense</code> layer keep tracks of each neuron's weights. When fed with some inputs,
it will return the computed output of each neuron.</p>
<pre><code class="language-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DenseLayer</span><span class="hljs-params">(object)</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, nb_neurons, input_shape)</span>:</span>
        <span class="hljs-string">"""
        For each neuron:
            create `input_shape` random weights: one for each input
        """</span>
        self.neurons_weights = []
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(nb_neurons):
            self.neurons_weights.append(
                np.random.random(input_shape)
            )

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">predict</span><span class="hljs-params">(self, inputs)</span>:</span>
        <span class="hljs-string">"""
        For each neuron:
            compute its output
        returns all outputs
        """</span>
        outputs = []
        <span class="hljs-keyword">for</span> neuron_weights <span class="hljs-keyword">in</span> self.neurons_weights:
            outputs.append(neuron(inputs, neuron_weights))
        <span class="hljs-keyword">return</span> outputs
</code></pre>
<p><code>Sequential</code> is rather straightforward:</p>
<pre><code class="language-python"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SequentialModel</span><span class="hljs-params">(object)</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self)</span>:</span>
        self.layers = []

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add</span><span class="hljs-params">(self, layer)</span>:</span>
        self.layers.append(layer)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">predict</span><span class="hljs-params">(self, inputs)</span>:</span>
        <span class="hljs-string">"""
        For each layer:
            compute its output using the previous layer's output as input
        returns last layer's output
        """</span>
        <span class="hljs-keyword">for</span> layer <span class="hljs-keyword">in</span> self.layers:
            inputs = layer.predict(inputs)
        <span class="hljs-keyword">return</span> inputs
</code></pre>
<p>Finally, we can use all those pieces to create a multi-layer network:</p>
<pre><code class="language-python">model = SequentialModel()
model.add(DenseLayer(<span class="hljs-number">3</span>, input_shape = <span class="hljs-number">2</span>))
model.add(DenseLayer(<span class="hljs-number">3</span>, input_shape = <span class="hljs-number">3</span>))
model.add(DenseLayer(<span class="hljs-number">2</span>, input_shape = <span class="hljs-number">3</span>))

model.predict([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>])
</code></pre>
<div class="note">
<p>Whether you want to reimplement part of the api or you have troubles
understanding a certain topic, I highly encourage you to take a look at keras
source code. It's well written and well documented, it should be a great source
of knowledges.</p>
</div>

		</div>
	</body>
	</html>
	